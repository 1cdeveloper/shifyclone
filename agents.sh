#!/bin/bash

# ==============================================================================
# ü§ñ AI AGENTS RUNNER & PROJECT GUIDE
# ==============================================================================
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (Bot + Celery) –∏ —Å–ª—É–∂–∏—Ç 
# –∫—Ä–∞—Ç–∫–∏–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–º –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞.
#
# üìÇ –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:
# ------------------
# - resume_roaster/        : –û—Å–Ω–æ–≤–Ω–∞—è Django –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è.
# - resume_roaster/bot/    : –õ–æ–≥–∏–∫–∞ Telegram –±–æ—Ç–∞ –∏ AI –∞–≥–µ–Ω—Ç–æ–≤.
#   - handlers/ (bot.py)    : –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (PDF –∏ —Ç–µ–∫—Å—Ç).
#   - tasks.py             : –§–æ–Ω–æ–≤—ã–µ Celery –∑–∞–¥–∞—á–∏ (AI –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—é–º–µ).
#   - models.py            : –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–∂–∞—Ä–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å–æ–≤.
# - docker-compose.yml     : –û–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (Postgres, RabbitMQ).
# - .env                   : –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–¢–æ–∫–µ–Ω—ã, –ë–î).
#
# üß† –ü–û–ß–ï–ú–£ –í–°–Å –¢–ê–ö –£–°–¢–†–û–ï–ù–û?
# --------------------------
# 1. Django         : –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∞–¥–º–∏–Ω–∫–∞ –∏ ORM –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
# 2. Celery + RMQ   : AI –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–ø—Ä–æ–∂–∞—Ä–∫–∞) –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –≤—Ä–µ–º—è. –ß—Ç–æ–±—ã –±–æ—Ç
#                     –Ω–µ "–≤–∏—Å–µ–ª", –º—ã –≤—ã–Ω–æ—Å–∏–º —Ç—è–∂–µ–ª—É—é –ª–æ–≥–∏–∫—É –≤ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏.
# 3. Postgres       : –ù–∞–¥–µ–∂–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–µ–∫—Å—Ç–æ–≤ —Ä–µ–∑—é–º–µ.
#
# ==============================================================================

echo "üöÄ –ó–∞–ø—É—Å–∫ AI –∞–≥–µ–Ω—Ç–æ–≤..."

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -f .env ]; then
    echo "‚ö†Ô∏è –û—à–∏–±–∫–∞: –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ .env.example –≤ .env"
    exit 1
fi

# 2. –ó–∞–ø—É—Å–∫ Celery –≤–æ—Ä–∫–µ—Ä–∞ (–§–æ–Ω–æ–≤—ã–µ AI –∑–∞–¥–∞—á–∏)
# –õ–æ–≥–∏–∫–∞: resume_roaster/bot/tasks.py
echo "üì¶ –ó–∞–ø—É—Å–∫ Celery worker (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)..."
poetry run celery -A resume_roaster worker --loglevel=info &
CELERY_PID=$!

# 3. –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ (–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
# –õ–æ–≥–∏–∫–∞: resume_roaster/bot/bot.py –∏ management/commands/run_bot.py
echo "ü§ñ –ó–∞–ø—É—Å–∫ Telegram Bot..."
poetry run python manage.py run_bot

# 4. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
# –ö–æ–≥–¥–∞ –±–æ—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è (Ctrl+C), —É–±–∏–≤–∞–µ–º —Ñ–æ–Ω–æ–≤–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞
kill $CELERY_PID
echo "üëã –ê–≥–µ–Ω—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
